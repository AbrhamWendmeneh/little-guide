<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reset Password - LittleGuide</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      window.ENV = {
        SUPABASE_URL: "https://qnafvveopvlgvgybpyue.supabase.co",
        SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFuYWZ2dmVvcHZsZ3ZneWJweXVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM0MzI2NTIsImV4cCI6MjA1OTAwODY1Mn0.Xcnl0-iq1PsSjPMvcvCelq5mIpn8PLdZLT_HFd9szSU",
      };
    </script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        padding: 40px;
        max-width: 500px;
        width: 100%;
        text-align: center;
      }

      .logo {
        width: 80px;
        height: 80px;
        margin: 0 auto 30px;
        background: linear-gradient(135deg, #e11d48, #8b5cf6);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 32px;
        font-weight: bold;
      }

      .status-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
      }

      .status-icon.success {
        background: #dcfce7;
        color: #16a34a;
      }

      .status-icon.error {
        background: #fef2f2;
        color: #dc2626;
      }

      h1 {
        font-size: 28px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 12px;
      }

      .subtitle {
        font-size: 16px;
        color: #6b7280;
        line-height: 1.5;
        margin-bottom: 30px;
      }

      .form-container {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 24px;
        margin: 20px 0;
        text-align: left;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
      }

      .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.2s;
      }

      .form-input:focus {
        outline: none;
        border-color: #8b5cf6;
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
      }

      .form-input.error {
        border-color: #dc2626;
      }

      .form-error {
        color: #dc2626;
        font-size: 14px;
        margin-top: 4px;
      }

      .password-requirements {
        background: #f0f9ff;
        border: 1px solid #bae6fd;
        border-radius: 8px;
        padding: 12px;
        margin-top: 8px;
        font-size: 14px;
        color: #0369a1;
      }

      .password-requirements ul {
        margin: 8px 0 0 0;
        padding-left: 20px;
      }

      .password-requirements li {
        margin-bottom: 4px;
      }

      .button {
        background: #8b5cf6;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        margin: 10px;
        transition: background-color 0.2s;
        width: 100%;
      }

      .button:hover {
        background: #7c3aed;
      }

      .button:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }

      .info-box {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 20px;
        margin: 20px 0;
      }

      .info-title {
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 8px;
      }

      .info-text {
        font-size: 14px;
        color: #6b7280;
        line-height: 1.5;
      }

      .footer {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #e5e7eb;
        font-size: 14px;
        color: #6b7280;
      }

      .footer a {
        color: #8b5cf6;
        text-decoration: none;
      }

      .footer a:hover {
        text-decoration: underline;
      }

      .hidden {
        display: none;
      }

      @media (max-width: 480px) {
        .container {
          padding: 30px 20px;
        }

        h1 {
          font-size: 24px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="logo" style="background: none; padding: 0">
        <img
          src="app-icon.png"
          alt="LittleGuide Logo"
          style="
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: block;
            margin: 0 auto;
            object-fit: cover;
          "
        />
      </div>

      <div id="form-section">
        <h1>Reset Your Password</h1>
        <p class="subtitle">
          Enter your new password below to complete the reset process.
        </p>

        <div class="form-container">
          <form id="password-reset-form">
            <div class="form-group">
              <label for="new-password" class="form-label">New Password</label>
              <input
                type="password"
                id="new-password"
                class="form-input"
                placeholder="Enter your new password"
                required
                minlength="8"
              />
              <div class="password-requirements">
                <strong>Password Requirements:</strong>
                <ul>
                  <li>At least 8 characters long</li>
                  <li>Contains at least one uppercase letter</li>
                  <li>Contains at least one lowercase letter</li>
                  <li>Contains at least one number</li>
                </ul>
              </div>
              <div id="password-error" class="form-error hidden"></div>
            </div>

            <div class="form-group">
              <label for="confirm-password" class="form-label">Confirm Password</label>
              <input
                type="password"
                id="confirm-password"
                class="form-input"
                placeholder="Confirm your new password"
                required
              />
              <div id="confirm-error" class="form-error hidden"></div>
            </div>

            <button type="submit" class="button" id="reset-button">
              Reset Password
            </button>
          </form>
        </div>
      </div>

      <div id="success-section" class="hidden">
        <div class="status-icon success">âœ“</div>
        <h1>Password Reset Complete! ðŸŽ‰</h1>
        <p class="subtitle">
          Your password has been successfully updated. You can now sign in with your new password.
        </p>

        <div class="info-box">
          <div class="info-title">âœ… Password Updated</div>
          <div class="info-text">
            Your password has been successfully reset. You can now sign in to your LittleGuide account with your new password.
          </div>
        </div>

        <a href="#" class="button" id="sign-in-link">Return to App</a>
      </div>

      <div id="error-section" class="hidden">
        <div class="status-icon error">âš </div>
        <h1>Reset Failed</h1>
        <p class="subtitle" id="error-message">
          Something went wrong. Please try again or contact support.
        </p>

        <a href="#" class="button" id="retry-link">Try Again</a>
      </div>

      <div class="footer">
        Need help? Contact
        <a href="mailto:support@littleguide.ai">support@littleguide.ai</a>
      </div>
    </div>

    <script>
      (function() {
        const supabaseUrl = window.ENV?.SUPABASE_URL;
        const supabaseAnonKey = window.ENV?.SUPABASE_ANON_KEY;

        if (
          !supabaseUrl ||
          !supabaseAnonKey ||
          supabaseUrl === "https://qnafvveopvlgvgybpyue.supabase.co" ||
          supabaseAnonKey === "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFuYWZ2dmVvcHZsZ3ZneWJweXVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM0MzI2NTIsImV4cCI6MjA1OTAwODY1Mn0.Xcnl0-iq1PsSjPMvcvCelq5mIpn8PLdZLT_HFd9szSU"
        ) {
          console.error(
            "Supabase configuration missing. Please set SUPABASE_URL and SUPABASE_ANON_KEY environment variables."
          );
          return;
        }

        // Initialize Supabase client
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

        // Get URL parameters
        function getUrlParams() {
          const urlParams = new URLSearchParams(window.location.search);
          const hashParams = new URLSearchParams(window.location.hash.substring(1));

          return {
            token: urlParams.get("token") || hashParams.get("token"),
            type: urlParams.get("type") || hashParams.get("type"),
            access_token: urlParams.get("access_token") || hashParams.get("access_token"),
            refresh_token: urlParams.get("refresh_token") || hashParams.get("refresh_token"),
          };
        }

        // Show section
        function showSection(sectionId) {
          document.getElementById("form-section").classList.add("hidden");
          document.getElementById("success-section").classList.add("hidden");
          document.getElementById("error-section").classList.add("hidden");
          document.getElementById(sectionId).classList.remove("hidden");
        }

        // Show error
        function showError(message) {
          document.getElementById("error-message").textContent = message;
          showSection("error-section");
        }

        // Show form error
        function showFormError(elementId, message) {
          const errorElement = document.getElementById(elementId);
          errorElement.textContent = message;
          errorElement.classList.remove("hidden");
          document.getElementById(elementId.replace("-error", "")).classList.add("error");
        }

        // Clear form error
        function clearFormError(elementId) {
          const errorElement = document.getElementById(elementId);
          errorElement.textContent = "";
          errorElement.classList.add("hidden");
          document.getElementById(elementId.replace("-error", "")).classList.remove("error");
        }

        // Validate password strength
        function validatePassword(password) {
          const requirements = {
            length: password.length >= 8,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            number: /\d/.test(password),
          };

          const isValid = Object.values(requirements).every(Boolean);
          return { isValid, requirements };
        }

        // Reset password
        async function resetPassword(newPassword) {
          try {
            const { data, error } = await supabase.auth.updateUser({
              password: newPassword,
            });

            if (error) {
              console.error("Password reset error:", error);
              throw error;
            }

            console.log("Password reset successful");
            showSection("success-section");
          } catch (error) {
            console.error("Password reset error:", error);
            showFormError("password-error", `Failed to reset password: ${error.message}`);
          }
        }

        // Initialize page
        function initializePage() {
          const { token, type, access_token, refresh_token } = getUrlParams();

          console.log("Password reset params:", { token: !!token, type, access_token: !!access_token });

          // Check if we have recovery tokens
          if (type === "recovery" && access_token) {
            console.log("Setting session with recovery tokens");
            supabase.auth.setSession({
              access_token,
              refresh_token,
            }).then(({ error }) => {
              if (error) {
                console.error("Session error:", error);
                showError(`Failed to authenticate: ${error.message}`);
              }
            });
          } else if (!token && !access_token) {
            showError("No valid reset token found in URL");
            return;
          }

          // Show the form
          showSection("form-section");
        }

        // Handle form submission
        document.getElementById("password-reset-form").addEventListener("submit", async (e) => {
          e.preventDefault();
          
          const newPassword = document.getElementById("new-password").value;
          const confirmPassword = document.getElementById("confirm-password").value;
          
          // Clear previous errors
          clearFormError("password-error");
          clearFormError("confirm-error");
          
          // Validate password
          const validation = validatePassword(newPassword);
          if (!validation.isValid) {
            showFormError("password-error", "Password does not meet requirements");
            return;
          }
          
          // Check if passwords match
          if (newPassword !== confirmPassword) {
            showFormError("confirm-error", "Passwords do not match");
            return;
          }
          
          // Disable form during submission
          const submitButton = document.getElementById("reset-button");
          submitButton.disabled = true;
          submitButton.textContent = "Resetting...";
          
          try {
            await resetPassword(newPassword);
          } finally {
            submitButton.disabled = false;
            submitButton.textContent = "Reset Password";
          }
        });

        // Handle sign-in link
        document.getElementById("sign-in-link").addEventListener("click", (e) => {
          e.preventDefault();
          try {
            window.close();
          } catch (e) {
            window.location.href = "https://abrhamwendmeneh.github.io/little-guide/";
          }
        });

        // Handle retry link
        document.getElementById("retry-link").addEventListener("click", (e) => {
          e.preventDefault();
          window.location.href = "https://abrhamwendmeneh.github.io/little-guide/";
        });

        // Start when page loads
        document.addEventListener("DOMContentLoaded", initializePage);
      })();
    </script>
  </body>
</html>
